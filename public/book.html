<!DOCTYPE html>  <html lang="id">  
<head>  
  <meta charset="UTF-8" />  
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>  
  <title>Booking - Nona Tarot</title> 
  
  <!-- ‚ú® Magical Font -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>  
    :root {  
      --primary: #6a4cff;  
      --primary-soft: #f2efff;  
      --text-dark: #2e2e38;  
      --text-muted: #6b6b7a;  
      --border: #e6e4f0;  
    }  
  
    * {  
      box-sizing: border-box;  
    }  
  
    body {  
      margin: 0;  
      background: linear-gradient(180deg, #f6f3ff, #ffffff);  
      min-height: 100vh;  
      display: flex;  
      justify-content: center;  
      align-items: center;  
      padding: 16px;  
      color: var(--text-dark); 
      font-family: "Playfair Display", serif;
    }  
  
    .container {  
      width: 100%;  
      max-width: 420px;  
    }  
  
    .card {  
      background: #fff;  
      border-radius: 16px;  
      padding: 24px;  
      box-shadow: 0 20px 40px rgba(106, 76, 255, 0.12);  
      border: 1px solid var(--border);  
    }  
  
    h1 {  
      margin: 0 0 6px;  
      text-align: center;  
      font-size: 24px;  
      color: var(--primary);  
    }  
  
    h2 {  
      margin: 0 0 24px;  
      text-align: center;  
      font-size: 14px;  
      color: var(--text-muted);  
    }  
  
    h2 span {  
      color: var(--primary);  
      font-weight: 600;
      font-size: 24px;
    }  
  
    /* üîÆ Ritual Guide */
    .ritual {
      background: var(--primary-soft);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 22px;
      font-size: 14px;
      line-height: 1.8;
      color: var(--text-dark);
    }

    .ritual b {
      color: var(--primary);
      font-weight: 600;
    }

    .ritual .title {
      text-align: center;
      font-size: 16px;
      margin-bottom: 12px;
      color: var(--primary);
      letter-spacing: 0.4px;
    }
  
    form {  
      display: flex;  
      flex-direction: column;  
      gap: 14px;  
    }  
  
    label {  
      font-size: 14px;  
      color: var(--text-muted);  
      display: flex;  
      flex-direction: column;  
      gap: 6px;  
    }  
  
    input, select {  
      padding: 12px 14px;  
      border-radius: 10px;  
      border: 1px solid var(--border);  
      font-size: 14px;  
    }  
  
    input:focus, select:focus {  
      outline: none;  
      border-color: var(--primary);  
      box-shadow: 0 0 0 3px rgba(106, 76, 255, 0.15);  
    }  
  
    button {  
      margin-top: 10px;  
      width: 100%;  
      padding: 14px;  
      border-radius: 12px;  
      border: none;  
      background: linear-gradient(135deg, #6a4cff, #8b6cff);  
      color: #fff;  
      font-size: 15px;  
      font-weight: 600;  
      cursor: pointer;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;  
    }  
  
    button:disabled {  
      opacity: 0.7;  
      cursor: not-allowed;  
    }  
  
    /* ===== MODAL ===== */  
    .modal {  
      position: fixed;  
      inset: 0;  
      background: rgba(0,0,0,0.45);  
      display: none;  
      justify-content: center;  
      align-items: center;  
      padding: 16px;  
      z-index: 999;  
    }  
  
    .modal.show {  
      display: flex;  
    }  
  
    .modal-card {  
      background: #fff;  
      border-radius: 16px;  
      padding: 22px;  
      max-width: 420px;  
      width: 100%;  
      box-shadow: 0 30px 60px rgba(0,0,0,0.25);  
      text-align: center;  
    }  
  
    .modal-card h3 {  
      margin: 0 0 10px;  
      color: var(--primary);  
    }  
  
    .modal-card p {  
      font-size: 14px;  
      color: var(--text-muted);  
      line-height: 1.6;  
      margin-bottom: 14px;  
    }  
  
    .rekening-box {  
      background: var(--primary-soft);  
      border-radius: 12px;  
      padding: 14px;  
      margin-bottom: 12px;  
    }  
  
    .rekening-box strong {  
      display: block;  
      font-size: 16px;  
      color: var(--primary);  
      margin-bottom: 6px;  
    }  
  
    .btn-copy {  
      background: #fff;  
      border: 1px dashed var(--primary);  
      color: var(--primary);  
      padding: 10px;  
      border-radius: 10px;  
      font-size: 14px;  
      cursor: pointer;  
      width: 100%;  
      margin-bottom: 10px;  
    }  
  
    .btn-secondary {  
      background: #eee;  
      color: #333;  
      width: 100%;  
      margin-top: 8px;  
    }
    
    .btn-copy.copied {
  background: linear-gradient(135deg, #6a4cff, #8b6cff);
  color: #fff;
  border: none;
}

.btn-copy.copied::after {
  content: " ‚úì";
  font-weight: 600;
}

textarea {
  padding: 12px 14px;
  border-radius: 10px;
  border: 1px solid var(--border);
  font-size: 14px;
  resize: vertical;
  min-height: 120px;
  font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
}

textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(106, 76, 255, 0.15);
}
  </style>  </head>  <body>  <div class="container">  
  <div class="card">  
    <h1>Booking Form</h1>  
    <h2>Sisa Slot Hari Ini: <span id="remainingSlot">Loading...</span></h2> 
    
     <!-- üîÆ CARA PEMESANAN -->
    <div class="ritual">
      <div class="title">üîÆ Cara Pemesanan ‚ú®</div>

      Semesta selalu memberi tanda, pastikan <b>slot hari ini masih tersedia</b>
      sebelum memulai perjalananmu üåô<br><br>

      Jika slot tersedia, isi <b>form booking</b> dengan niat dan cerita yang jujur.
      Setiap kata akan membantu semesta membaca energimu ‚ú®<br><br>

      Setelah itu, kamu akan diarahkan ke <b>WhatsApp</b> untuk konfirmasi üí¨
      Mohon lakukan <b>pembayaran hanya setelah berhasil kirim pesan di WhatsApp</b>.<br><br>

      Jangan lupa simpan dan kirim <b>bukti pembayaran</b>.
      Setelah selesai, bacaanmu akan segera diproses üîÆüíú
    </div>
  
  <!-- FORM -->
    <form id="bookingForm">  
  <label>Nama  
    <input type="text" id="name" required>  
  </label>  

  <label>Email  
    <input type="email" id="email" required>  
  </label>  

  <label>Paket  
    <select id="package" required>  
      <option value="">-- Pilih Paket --</option>  
      <option value="Pertanyaan BPJS">Pertanyaan BPJS (99000)</option>  
      <option value="Bacaan Semesta">Bacaan Semesta (199000)</option>  
      <option value="All Package">All Package (299000)</option>  
    </select>  
  </label>  
  
  <label>Cerita / Pertanyaan
  <textarea
    id="story"
    placeholder="Hi best, silahkan cerita secukupnya yah , lalu berikan pertanyaan ke aku atas keresahanmu, aku siap dampingi kamu untuk menemukan jawaban üîÆüôáüèª‚Äç‚ôÄÔ∏è"
    required
  ></textarea>
</label>

  <button type="submit">Booking</button>  
</form>

  </div>  
</div>  <!-- ===== MODAL PEMBAYARAN ===== -->  <div class="modal" id="paymentModal">  
  <div class="modal-card">  
    <h3>Informasi Pembayaran</h3>  <p>  
  Simpan nomor rekening berikut.<br>  
  <b>Jangan transfer sebelum berhasil kirim pesan WA.</b>  
</p>  

<div class="rekening-box">  
  <strong id="rekeningText">BRI ‚Ä¢ 308101002125500</strong>  
  a.n. Ranni Anugrah Pramudhita  
</div>  

<button class="btn-copy" onclick="copyRekening()">üìã Salin Nomor Rekening</button>  

<p style="font-size:13px">  
  Transfer dilakukan setelah berhasil chat WA dan kirim bukti pembayaran via WhatsApp.  
</p>  

<button id="btnProceed" onclick="proceedToWA()">Lanjut ke WhatsApp</button>  
<button class="btn-secondary" onclick="closeModal()">Batal</button>

  </div>  
</div>  <script>  
  let formData = {};    
  
  async function fetchSlot() {  
    try {  
      const res = await fetch('/api/slot');  
      const data = await res.json();  
      document.getElementById('remainingSlot').textContent =  
        data.success ? data.remaining : 'Error';  
    } catch {  
      document.getElementById('remainingSlot').textContent = 'Error';  
    }  
  }  
  
  fetchSlot();  
  
  document.getElementById('bookingForm').addEventListener('submit', (e) => {  
    e.preventDefault();  
  
    formData = {  
      name: document.getElementById('name').value,  
      email: document.getElementById('email').value,  
      paket: document.getElementById('package').value, 
      story: document.getElementById('story').value
    };  
  
    if (!formData.paket) {  
      alert('Silakan pilih paket');  
      return;  
    }  
  
    document.getElementById('paymentModal').classList.add('show');  
  });  
  
  function closeModal() {  
    document.getElementById('paymentModal').classList.remove('show');  
  }  
  

  function copyRekening() {
    const btn = document.querySelector('.btn-copy');
    const rekening = document
      .getElementById('rekeningText')
      .innerText.replace(/\D/g, '');

    // fallback aman untuk iOS & iframe
    const input = document.createElement('input');
    input.value = rekening;
    document.body.appendChild(input);
    input.select();
    document.execCommand('copy');
    document.body.removeChild(input);

    // efek visual
    btn.classList.add('copied');
    btn.innerText = 'Tersalin ';

    setTimeout(() => {
      btn.classList.remove('copied');
      btn.innerText = 'üìã Salin Nomor Rekening';
    }, 2000);
  }

let isProcessing = false;

async function proceedToWA() {
  // üîí anti double click
  if (isProcessing) return;
  isProcessing = true;

  const btn = document.getElementById('btnProceed');
  const form = document.getElementById('bookingForm');

  btn.disabled = true;
  btn.innerText = 'Memproses...';
  closeModal();

  const waNumber = '6285600045005';

  // ‚úÖ BUKA WA LANGSUNG (USER INITIATED ‚Üí AMAN POPUP BLOCKER)
  const waWindow = window.open('', '_blank');

if (waWindow) {
  waWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Menuju WhatsApp...</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <style>
        body {
          font-family: system-ui, -apple-system, Segoe UI, sans-serif;
          display: flex;
          align-items: center;
          justify-content: center;
          height: 100vh;
          background: #f6f3ff;
          color: #6a4cff;
        }
      </style>
    </head>
    <body>
      <div>üîÆ Menghubungkan ke WhatsApp‚Ä¶</div>
    </body>
    </html>
  `);
  waWindow.document.close();
}

  try {
    const res = await fetch('/api/book', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });

    const data = await res.json();

    if (!data.success) {
      waWindow.close();
      alert(data.error || 'Booking gagal');
      return;
    }

    // reset form & refresh slot
    form.reset();
    fetchSlot();

    // üîÆ PESAN WA FINAL
    const message = `üîÆüôáüèª‚Äç‚ôÄÔ∏è *HII NONA TAROT, BUKTI PEMBAYARAN KE BRI 308101002125500 An RANNI ANUGRAH PRAMUDHITA BAKAL AKU KIRIM SETELAH PESAN INI* üôáüèª‚Äç‚ôÄÔ∏èüîÆ

Informasi Booking:

Nama: ${data.name}
Email: ${data.email}
Paket: ${data.paket}

Cerita / Pertanyaan:
${data.story}

Kode Booking: ${data.code}
`;

    const waUrl =
      `https://api.whatsapp.com/send?phone=${waNumber}&text=${encodeURIComponent(message)}`;

    // ‚úÖ UPDATE TAB WA (AMAN DI SEMUA BROWSER)
    waWindow.location.href = waUrl;

  } catch (err) {
    waWindow.close();
    alert('Terjadi kesalahan koneksi');
    console.error(err);
  } finally {
    btn.disabled = false;
    btn.innerText = 'Lanjut ke WhatsApp';
    isProcessing = false; // üîì unlock
  }
}


</script>  </body>  
</html>
